<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE muclient>
<muclient>
  <plugin
    name="SmartMove"
    author="Morienda"
    id="ab12cd34ef56ab78cd90ef13"
    language="Lua"
    purpose="Context-aware movement (Retreat/Stand/Move) with Multiclass support"
    date_written="2025-11-24"
    requires="4.59"
    version="1.0"
    save_state="y"
  >
  <description trim="y">
  <![CDATA[
  SmartMove - Context Aware Movement for Aardwolf
  
  Usage: 
    Map your numpad keys to: smartmove n, smartmove e, etc.

  Logic:
    1. If Sleeping/Resting: Sends 'stand' then moves.
    2. If Fighting: 
       - Checks Class History (Multiclass support).
       - Checks Level + (Tier * 10).
       - If eligible, sends 'retreat <dir>'.
       - If ineligible, attempts standard move (fails gracefully).
    3. Otherwise: Moves normally.

  Commands:
    smartmove <dir>   : Move (n, s, e, w, u, d)
    smartmove help    : Show status and syntax
    smartmove debug   : Toggle verbose diagnostic logs
  ]]>
  </description>
  </plugin>

  <aliases>
    <alias 
      match="smartmove *" 
      enabled="y" 
      regexp="n" 
      ignore_case="y" 
      send_to="12" 
      omit_from_output="y" 
      script="SM_Dispatch" 
    />
  </aliases>

  <script><![CDATA[
-- =============================================================================
--  SmartMove v1.0 by Morienda
--  Aardwolf MUSHclient Plugin
-- =============================================================================

-- Performance Locals
local exec   = Execute
local note   = ColourNote
local sub    = string.sub
local lower  = string.lower
local tonum  = tonumber
local math_min = math.min
local gmcpf  = nil 

-- State
local DEBUG_MODE = false

-- Configuration: Class Retreat Requirements
-- 0=Mage, 1=Cleric, 2=Thief, 3=Warrior, 4=Ranger, 5=Paladin, 6=Psi, 7=Necro...
local CLASS_REQS = {
  ["2"] = 142, -- Thief
  ["3"] = 116, -- Warrior
  ["4"] = 121, -- Ranger
  ["5"] = 118  -- Paladin
}

local CLASS_NAMES = {
  ["0"]="Mage", ["1"]="Cleric", ["2"]="Thief", ["3"]="Warrior", 
  ["4"]="Ranger", ["5"]="Paladin", ["6"]="Psi", ["7"]="Necro"
}

local DIR_MAP = {
  ["n"] = "north", ["s"] = "south", ["e"] = "east", ["w"] = "west",
  ["u"] = "up",    ["d"] = "down"
}

-- =============================================================================
--  Utilities
-- =============================================================================

local function trim(s) return (s or ""):gsub("^%s*", ""):gsub("%s*$", "") end

local function dbg(msg)
  if DEBUG_MODE then note("orange", "", "[SM-DEBUG] " .. msg) end
end

local function get_char_info()
  if not gmcpf then return nil end
  local status = gmcpf("char.status")
  local base   = gmcpf("char.base")
  if not status or not base then return nil end
  
  return {
    state = tonum(status.state), 
    level = tonum(status.level),
    tier  = tonum(base.tier),
    classes_str = base.classes or "" 
  }
end

-- Core Logic: Can the player retreat based on ANY of their classes?
local function check_retreat(info)
  if not info then return false end
  
  -- Calculate Effective Level
  local tier_bonus = math_min(info.tier, 9) * 10
  local eff_level = info.level + tier_bonus
  
  if DEBUG_MODE then
    dbg("Checking Retreat for Classes: " .. info.classes_str .. " | EffLvl: " .. eff_level)
  end

  -- Check every class in history string
  for i = 1, #info.classes_str do
    local class_id = sub(info.classes_str, i, i)
    local req = CLASS_REQS[class_id]
    
    if req then
      if eff_level >= req then
        if DEBUG_MODE then dbg("Pass! Class ID " .. class_id .. " Req " .. req .. " <= " .. eff_level) end
        return true
      end
    end
  end
  
  if DEBUG_MODE then dbg("Fail. No eligible classes found.") end
  return false
end

-- =============================================================================
--  Command Handlers
-- =============================================================================

function SM_Dispatch(name, line, wc)
  local arg = trim(wc[1]):lower()
  if arg == "debug" then SM_ToggleDebug()
  elseif arg == "?" or arg == "help" then SM_Help()
  else SM_DoMove(arg) end
end

function SM_ToggleDebug()
  DEBUG_MODE = not DEBUG_MODE
  note("silver", "", "[SmartMove] Debug Mode: ", (DEBUG_MODE and "lime" or "tomato"), "", tostring(DEBUG_MODE))
end

function SM_DoMove(input)
  local c = sub(input, 1, 1)
  if not DIR_MAP[c] then
    note("tomato", "", "[SmartMove] Invalid direction: " .. input)
    return
  end
  
  local info = get_char_info()
  
  -- Safety: If GMCP isn't ready, just move standard to avoid locking player
  if not info then 
    exec(c)
    return
  end

  -- 1. Sleep/Rest -> Stand
  if info.state == 9 or info.state == 11 then
    SendNoEcho("stand")
    exec(c)
    return
  end

  -- 2. Combat -> Retreat Check
  if info.state == 8 then
    if check_retreat(info) then
      exec("retreat " .. c)
    else
      -- Try normal move. MUD will error "No way! You are fighting!", 
      -- which is better than client spamming "Huh?" for missing skills.
      exec(c) 
    end
    return
  end

  -- 3. Normal Move
  exec(c)
end

function SM_Help()
  note("silver", "", string.rep("-", 60))
  ColourNote("cadetblue", "", " SmartMove v1.0", "silver", "", " by Morienda")
  note("silver", "", string.rep("-", 60))
  
  note("silver", "", " Commands:")
  note("silver", "", "   smartmove <n|e|s|w|u|d>  : Intelligent move")
  note("silver", "", "   smartmove debug          : Toggle diagnostic logs")
  note("silver", "", "")
  
  local info = get_char_info()
  if not info then 
    note("orange", "", " Status: Waiting for GMCP data...")
  else
    local tier_bonus = math_min(info.tier, 9) * 10
    local eff_level = info.level + tier_bonus
    local can_retreat_bool = check_retreat(info)
    
    ColourNote("silver", "", " Current Stats:")
    ColourNote("silver", "", "   Level: ", "cyan", "", info.level, "silver", "", "  Tier: ", "cyan", "", info.tier, "silver", "", "  Eff. Level: ", "lime", "", eff_level)
    ColourNote("silver", "", "   Classes: ", "cyan", "", info.classes_str)
    ColourNote("silver", "", "   Retreat Eligible: ", (can_retreat_bool and "lime" or "tomato"), "", tostring(can_retreat_bool))
  end
  note("silver", "", string.rep("-", 60))
end

-- =============================================================================
--  Lifecycle
-- =============================================================================

function OnPluginInstall()
  local ok = pcall(function() require "gmcphelper" end)
  if ok and type(gmcp) == "function" then 
    gmcpf = gmcp 
    -- Force update immediately
    SendNoEcho("protocols gmcp sendchar")
    SendNoEcho("protocols gmcp sendbase")
    SendNoEcho("protocols gmcp sendstatus")
    note("silver", "", "[SmartMove] v1.0 Loaded. Type ", "cyan", "", "smartmove help", "silver", "", " for info.")
  else
    note("tomato", "", "[SmartMove] Critical Error: GMCP Helper not found.")
  end
end

function OnPluginConnect()
  SendNoEcho("protocols gmcp sendchar")
  SendNoEcho("protocols gmcp sendbase")
  SendNoEcho("protocols gmcp sendstatus")
end

  ]]></script>
</muclient>