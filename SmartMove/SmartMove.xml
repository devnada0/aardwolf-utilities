<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE muclient>
<muclient>
  <plugin
    name="SmartMove"
    author="Morienda"
    id="ab12cd34ef56ab78cd90ef13"
    language="Lua"
    purpose="Context-aware movement and skills (Retreat/Survey/Stand)"
    date_written="2025-11-24"
    requires="4.59"
    version="1.3"
    save_state="y"
  >
  <description trim="y">
  <![CDATA[
  SmartMove v1.3 - Context Aware Actions for Aardwolf
  
  Usage: 
    Map your numpad keys to: smartmove n, smartmove e, etc.
    Map your scan key to: smartmove scan

  Logic:
    1. Movement:
       - Sleep/Rest: Auto-stand.
       - Combat: Checks Retreat eligibility (Multiclass/Tier aware). 
         Retreats if capable, moves normally if not.
    2. Scanning:
       - Sleep/Rest: Auto-stand.
       - Non-Combat: Uses standard 'scan'.
       - Combat: Checks Survey eligibility.
         Surveys if capable, Scans if not.

  Commands:
    smartmove <dir>   : Move (n, s, e, w, u, d)
    smartmove scan    : Context-aware scan/survey
    smartmove help    : Show stats and eligibility
    smartmove debug   : Toggle diagnostic logs
  ]]>
  </description>
  </plugin>

  <aliases>
    <alias 
      match="smartmove *" 
      enabled="y" 
      regexp="n" 
      ignore_case="y" 
      send_to="12" 
      omit_from_output="y" 
      script="SM_Dispatch" 
    />
  </aliases>

  <script><![CDATA[
-- =============================================================================
--  SmartMove v1.3 by Morienda
--  Aardwolf MUSHclient Plugin
-- =============================================================================

local exec   = Execute
local note   = ColourNote
local sub    = string.sub
local lower  = string.lower
local tonum  = tonumber
local math_min = math.min
local gmcpf  = nil 

local DEBUG_MODE = false

-- Configuration: Level Requirements
-- Class IDs: 0=Mage, 1=Cleric, 2=Thief, 3=Warrior, 4=Ranger, 5=Paladin...

local RETREAT_REQS = {
  ["2"] = 142, -- Thief
  ["3"] = 116, -- Warrior
  ["4"] = 121, -- Ranger
  ["5"] = 118  -- Paladin
}

local SURVEY_REQS = {
  ["2"] = 152, -- Thief
  ["3"] = 133, -- Warrior
  ["4"] = 137, -- Ranger
  ["5"] = 149  -- Paladin
}

local DIR_MAP = {
  ["n"] = "north", ["s"] = "south", ["e"] = "east", ["w"] = "west",
  ["u"] = "up",    ["d"] = "down"
}

-- =============================================================================
--  Utilities
-- =============================================================================

local function trim(s) return (s or ""):gsub("^%s*", ""):gsub("%s*$", "") end

local function dbg(msg)
  if DEBUG_MODE then note("orange", "", "[SM-DEBUG] " .. msg) end
end

local function get_char_info()
  if not gmcpf then return nil end
  local status = gmcpf("char.status")
  local base   = gmcpf("char.base")
  if not status or not base then return nil end
  
  return {
    state = tonum(status.state), 
    level = tonum(status.level),
    tier  = tonum(base.tier),
    classes_str = base.classes or "" 
  }
end

-- Generic Logic: Checks if any class in history meets the requirement
local function check_eligibility(info, req_table, skill_name)
  if not info then return false end
  
  -- Calculate Effective Level
  local tier_bonus = math_min(info.tier, 9) * 10
  local eff_level = info.level + tier_bonus
  
  if DEBUG_MODE then
    dbg("Checking " .. skill_name .. " for Classes: " .. info.classes_str .. " | EffLvl: " .. eff_level)
  end

  for i = 1, #info.classes_str do
    local class_id = sub(info.classes_str, i, i)
    local req = req_table[class_id]
    
    if req then
      if eff_level >= req then
        if DEBUG_MODE then dbg("Pass! Class ID " .. class_id .. " Req " .. req .. " <= " .. eff_level) end
        return true
      end
    end
  end
  
  if DEBUG_MODE then dbg("Fail. No eligible classes found for " .. skill_name) end
  return false
end

-- =============================================================================
--  Command Handlers
-- =============================================================================

function SM_Dispatch(name, line, wc)
  local arg = trim(wc[1]) -- Keep case for args, but lower for command check
  local cmd = arg:lower()
  
  if cmd == "debug" then SM_ToggleDebug()
  elseif cmd == "?" or cmd == "help" then SM_Help()
  elseif cmd == "scan" or cmd:sub(1,5) == "scan " then SM_DoScan(arg)
  else SM_DoMove(cmd) end
end

function SM_ToggleDebug()
  DEBUG_MODE = not DEBUG_MODE
  note("silver", "", "[SmartMove] Debug Mode: ", (DEBUG_MODE and "lime" or "tomato"), "", tostring(DEBUG_MODE))
end

function SM_DoScan(input)
  local args = input:sub(5) -- Strip "scan" (keep leading space if any)
  local info = get_char_info()
  
  if not info then 
    exec("scan" .. args)
    return
  end

  -- Auto-Stand (Sleep/Rest)
  if info.state == 9 or info.state == 11 then
    SendNoEcho("stand")
  end

  -- Logic: Only Survey if Fighting (8) AND Eligible
  if info.state == 8 then
    if check_eligibility(info, SURVEY_REQS, "Survey") then
      if DEBUG_MODE then dbg("In Combat + Eligible -> Surveying") end
      exec("survey" .. args)
      return
    else
      if DEBUG_MODE then dbg("In Combat but Not Eligible -> Scanning") end
    end
  else
    if DEBUG_MODE then dbg("Not in Combat -> Scanning") end
  end

  -- Default Fallback
  exec("scan" .. args)
end

function SM_DoMove(input)
  local c = sub(input, 1, 1)
  if not DIR_MAP[c] then
    note("tomato", "", "[SmartMove] Invalid direction: " .. input)
    return
  end
  
  local info = get_char_info()
  
  -- Safety: If GMCP isn't ready, move standard
  if not info then 
    exec(c)
    return
  end

  -- 1. Sleep/Rest -> Stand
  if info.state == 9 or info.state == 11 then
    SendNoEcho("stand")
    exec(c)
    return
  end

  -- 2. Combat -> Retreat Check
  if info.state == 8 then
    if check_eligibility(info, RETREAT_REQS, "Retreat") then
      exec("retreat " .. c)
    else
      exec(c) -- Try normal move
    end
    return
  end

  -- 3. Normal Move
  exec(c)
end

function SM_Help()
  note("silver", "", string.rep("-", 60))
  ColourNote("cadetblue", "", " SmartMove v1.3", "silver", "", " by Morienda")
  note("silver", "", string.rep("-", 60))
  
  note("silver", "", " Commands:")
  note("silver", "", "   smartmove <dir>   : Intelligent move (Retreats in combat)")
  note("silver", "", "   smartmove scan    : Intelligent scan (Surveys in combat)")
  note("silver", "", "   smartmove debug   : Toggle diagnostic logs")
  note("silver", "", "")
  
  local info = get_char_info()
  if not info then 
    note("orange", "", " Status: Waiting for GMCP data...")
  else
    local tier_bonus = math_min(info.tier, 9) * 10
    local eff_level = info.level + tier_bonus
    local can_retreat = check_eligibility(info, RETREAT_REQS, "Retreat")
    local can_survey  = check_eligibility(info, SURVEY_REQS, "Survey")
    
    ColourNote("silver", "", " Current Stats:")
    ColourNote("silver", "", "   Level: ", "cyan", "", info.level, "silver", "", "  Tier: ", "cyan", "", info.tier, "silver", "", "  Eff. Level: ", "lime", "", eff_level)
    ColourNote("silver", "", "   Classes: ", "cyan", "", info.classes_str)
    ColourNote("silver", "", "   Retreat: ", (can_retreat and "lime" or "tomato"), "", tostring(can_retreat), "silver", "", "  Survey: ", (can_survey and "lime" or "tomato"), "", tostring(can_survey))
  end
  note("silver", "", string.rep("-", 60))
end

-- =============================================================================
--  Lifecycle
-- =============================================================================

function OnPluginInstall()
  local ok = pcall(function() require "gmcphelper" end)
  if ok and type(gmcp) == "function" then 
    gmcpf = gmcp 
    -- Force update immediately
    SendNoEcho("protocols gmcp sendchar")
    SendNoEcho("protocols gmcp sendbase")
    SendNoEcho("protocols gmcp sendstatus")
    note("silver", "", "[SmartMove] v1.3 Loaded. Type ", "cyan", "", "smartmove help", "silver", "", " for info.")
  else
    note("tomato", "", "[SmartMove] Critical Error: GMCP Helper not found.")
  end
end

function OnPluginConnect()
  SendNoEcho("protocols gmcp sendchar")
  SendNoEcho("protocols gmcp sendbase")
  SendNoEcho("protocols gmcp sendstatus")
end

  ]]></script>
</muclient>